<?php

namespace App\Console\Commands;

use App\Models\Extra\Notification;
use App\Models\Extra\SMS;
use App\Models\Package;
use App\Models\User as ModelUser;
use App\Models\Warehouse;
use http\Client\Curl\User;
use Illuminate\Console\Command;
use Goutte\Client;
use Symfony\Component\HttpClient\HttpClient;
use thiagoalessio\TesseractOCR\TesseractOCR;

class UkraineExpress extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'ukraine:express {--w_id=1} {--type=all} {--package_id=0}';

    protected $warehouse;

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Command description';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     * @throws \Exception
     */
    public function handle()
    {
        try {
            $this->warehouse = Warehouse::find($this->option('w_id'));
            if ($this->option('type') == 'all') {
                $numbers = $this->getTrackingNumbers();
                sleep(3);
                $this->addNotAddedTrackingNumbers($numbers);
            } elseif ($this->option('type') == 'file') {
                $this->attachScreenFiles();
            } elseif ($this->option('type') == 'update') {
	        $this->updateTracking();
            } elseif ($this->option('type') == 'rescan') {
	        $this->rescanImage($this->option('package_id'));
            } else {
                $this->runOCR();
            }
        } catch (\Exception $exception) {
            dd($exception);
        }
    }

    public function addNotAddedTrackingNumbers($numbers)
    {
        $this->line("");
        $this->line("");
        $this->info("===== Started to add new packages =====");
        $this->line("");
        $this->line("");
        $warehouse = $this->warehouse;
        $packages = Package::where(function ($q) use ($warehouse) {
            $q->orWhere('warehouse_id', $warehouse->id)->orWhere('country_id', $warehouse->country_id);
        })->whereNotIn('tracking_code', $numbers)->whereNull('bot_comment')->where('status', 6)->get();
        //})->whereNotIn('tracking_code', $numbers)->where(function ($q) { $q->whereNull('bot_comment')->orWhere('bot_comment',"\n");})->where('status', 6)->get();
        dump(count($packages));

        foreach ($packages as $package) {
            dump($package->tracking_code);
            if (! in_array($package->tracking_code, $numbers) && $package->status == 6) {
                $code = $package->tracking_code;
                $exits = false;

                if (strlen($code) >= 10) {
                    $this->line("Checking  .. " . $code);
                    $start = -1 * strlen($code) + 1;
                    dump($start . " -- ");
                    for ($i = $start; $i <= -8; $i++) {
                        $code = substr($code, $i);
                        $this->line("Checking  .. " . $code);
                        if (in_array($code, $numbers)) {
                            $this->error('Found');
                            $exits = true;
                            break 1;
                        }
                        foreach ($numbers as $number) {
                            if (str_contains($number, $code)) {
                                $exits = true;
                                break 2;
                            }
                        }
                    }
                }

                if (! $exits && strlen($package->tracking_code) >= 9) {
                    $type = $package->type ? ($package->type->translate('en') ? $package->type->translate('en')->name : "Other") : 'Other';

                    $warning = $this->addTracking($package->tracking_code, $package->shipping_amount, $type);

                    /* Send notification */
                    if ((! $warning || str_contains(trim($warning), 'Ğ²Ğ½ĞµÑĞ»Ğ¸') || str_contains(trim($warning), 'Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½') || str_contains(trim($warning), 'Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½')) && ! str_contains(trim($warning), 'Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚')) {
                        $info = false;
                        $icon = 'ğŸ¤– ';
                        $text = 'É™lavÉ™ edildi.';
                    } else {
                        $info = true;
                        $icon = 'ğŸ†˜ ';
                        $text = 'É™lavÉ™ edilmir. AdminlÉ™r yoxlasÄ±n nÉ™ mÉ™sÉ™lÉ™dir.';
                        $content = $package->tracking_code . ". Error : " . $warning;
                        SMS::sendPureTextByNumber(env('UKRAINE_ERROR_PHONE'), $content);
                    }
                    $message = null;
                    $message .= $icon . "<a href='https://admin." . env('DOMAIN_NAME') . "/packages/" . $package->id . "/edit'>" . $package->tracking_code . "</a> tracking kod ilÉ™ olan baÄŸlama Ukraine Express-É™ " . $text;
                    if ($info) {
                        $message .= chr(10) . "Note : <i>" . $warning . "</i>";
                    }
                    sendTGMessage($message);

                    $package->bot_comment = $package->bot_comment . "\n" . $warning;
                    $package->save();
                }
            }
        }
    }

    public function addTracking($trackingCode, $price, $description)
    {
        if (strlen($trackingCode) < 9) {
            return false;
        }

        $client = $this->login();

        $crawler = $client->request('GET', 'https://ukraine-express.com/index.php?m=clientarea&d=dashboard&lang=ru&div=us');

        $this->info("Clicked to 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³ Ğ½Ğ¾Ğ¼ĞµÑ€' button");

        $form = $crawler->filter('.deliveryorder_form')->form();

        $form->setValues(['tracking' => $trackingCode, 'price_t' => $price, 'description_t' => $description]);

        $crawler = $client->request($form->getMethod(), $form->getUri(), $form->getPhpValues());

        $this->line("Waiting");
        sleep(5);
        $warning = null;

        try {
            $warning = $crawler ? $crawler->filter('.alert-error')->eq(0) : null;
        } catch (\Exception $exception) {
            $warning = $crawler ? $crawler->filter('.yellow_text')->eq(0) : null;
        }

        try {
            $warning = $warning ? $warning->text() : null;
        } catch (\Exception $exception) {
            $warning = null;
        }

        $this->info("Added new tracking number : " . $trackingCode);

        return $warning;
    }

    public function login()
    {
        if ($this->warehouse->panel_login && $this->warehouse->panel_password) {
            $client = new Client(HttpClient::create(['timeout' => 60]));
            $crawler = $client->request('GET', 'https://ukraine-express.com/');
            $form = $crawler->filter('.form-login')->form();
            $client->submit($form, [
                'p_code' => $this->warehouse->panel_login,
                'p_pin'  => $this->warehouse->panel_password,
            ]);

            $this->info("Logged to Ukraine Express panel.");
            sleep(2);

            return $client;
        } else {
            $this->error("No any credentials");
            exit();
        }
    }

    public function updateTracking()
    {
        $client = $this->login();

        $this->line("");
        $this->line("Started to update tracking ... ");
        $this->line("");
        $warehouse = $this->warehouse;
        $packages = Package::where(function ($q) use ($warehouse) {
            $q->orWhere('warehouse_id', $warehouse->id)->orWhere('country_id', $warehouse->country_id);
        })->where('weight', 0)->where('status', 6)->get();
        foreach ($packages as $package) {
            $this->line(' -- package ' .$package->custom_id. '  tracking_code '. $package->tracking_code);
            $crawler = $client->request('GET', 'https://ukraine-express.com/index.php?m=clientarea&d=mytrackings&lang=ru&div=us&filter=' . $package->tracking_code);

   	    $weight=0;


                $desc = $crawler->filter('.invoice__description')->eq(0)->filter('.tracking__notices');

                $countSubs = $desc->each(function ($node, $i) {
                    return $i;
                });
                $countSubs = end($countSubs);

                if ($countSubs !== false) {
                    for ($k = 0; $k <= $countSubs; $k++) {
                        if (str_contains($desc->eq($k)->text(), "ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ")) {
                            $weight = str_replace("ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ: ", "", $desc->eq($k)->text());
                            $weight = floatval(trim(str_replace("kg", "", $weight))) + 0;
                        }
                    }
                }

		if($weight != 0)
		{
                        $this->line("        updated weight " . $weight);
			$package->weight=$weight;
			$package->save();
		}
	}

    }

    public function getTrackingNumbers()
    {
        $client = $this->login();

        $this->line("");
        $this->line("Started to get Tracking numbers ... ");
        $crawler = $client->request('GET', 'https://ukraine-express.com/index.php?m=clientarea&d=mytrackings&lang=ru&div=us&from=0');
        $pageBar = $crawler->filter('.pagebar a')->each(function ($node, $i) {
            return $i;
        });
        $pageBar = 50;//end($pageBar) + 1;

        $trackingNumbers = [];

        for ($j = 0; $j <= $pageBar; $j++) {

            $this->line(' -- I just opened page : ' . $j);
            $crawler = $client->request('GET', 'https://ukraine-express.com/index.php?m=clientarea&d=mytrackings&lang=ru&div=us&from=' . 30 * $j);

            $count = $crawler->filter('.trecking_number')->each(function ($node, $i) {
                return $i;
            });

            for ($i = 0; $i <= end($count); $i++) {

                $arr = [];

                $arr['trackNumber'] = $crawler->filter('.trecking_number')->eq($i)->text();
                $desc = $crawler->filter('.invoice__description')->eq($i)->filter('.tracking__notices');

                $countSubs = $desc->each(function ($node, $i) {
                    return $i;
                });
                $countSubs = end($countSubs);

                if ($countSubs !== false) {
                    for ($k = 0; $k <= $countSubs; $k++) {
                        if (str_contains($desc->eq($k)->text(), "ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€")) {
                            $arr['trackNumber'] = str_replace("ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€: ", "", $desc->eq($k)->text());
                        }
                        if (str_contains($desc->eq($k)->text(), "ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ")) {
                            $arr['weight'] = str_replace("ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ: ", "", $desc->eq($k)->text());
                            $arr['weight'] = floatval(trim(str_replace("kg", "", $arr['weight']))) + 0;
                        }
                    }
                }
                $this->line(" ---- Getting " . $arr['trackNumber']);

                array_push($trackingNumbers, $arr);
            }
        }

        $this->line("");
        $this->line("");

        $this->line("---------------------------------");
        $this->line("---- Started to check with DB ---");
        $this->line("---------------------------------");

        $numbers = [];
        foreach ($trackingNumbers as $list) {
            $code = $list['trackNumber'];
            $this->error($code);
            $item = Package::withTrashed()->where("tracking_code", "like", $code . "%")->orderBy('deleted_at', 'asc')->first();

            if (! $item && strlen($code) >= 10) {
                $start = -1 * strlen($code) + 1;
                for ($i = $start; $i <= -8; $i++) {
                    $code = substr($code, $i);
                    $item = Package::withTrashed()->where("tracking_code", "like", $code . "%")->orderBy('deleted_at', 'asc')->first();
                    //$this->warn('Checking .. ' . $code);

                    if ($item) {
                        break;
                    }
                }
            }

            $numbers[] = $list['trackNumber'];
            if (isset($list['weight'])) {

                if (! $item) {
                    $this->error(" ---- Cannot find " . $list['trackNumber'] . ". Inserting ... ");
                    $screenFile = $this->getImage($client, $list['trackNumber']);

                    $pacakge = new Package();
                    $pacakge->tracking_code = $list['trackNumber'];
                    if (! $pacakge->weight) {
                        $this->warn(" --- > " . $list['weight'] . "weight was updated");
                        $pacakge->weight = $list['weight'];
                    }

                    $pacakge->warehouse_id = $this->warehouse->id;
                    $pacakge->status = 0;
                    $pacakge->screen_file = $screenFile;
                    $pacakge->save();

                    /* Send notification */
                    $message = null;
                    $message .= "ğŸ†˜ <a href='https://admin." . env('DOMAIN_NAME') . "/unknowns?search_type=&q=" . $pacakge->tracking_code . "'>" . $pacakge->tracking_code . "</a> bazamÄ±zda tapÄ±lmadÄ± vÉ™ UE-dan migrate edildi. Sahibi mÃ¼tlÉ™q tapÄ±lmalÄ±dÄ±r.";

                    if ($screenFile) {
                        $message .= " Ã‡É™kilmiÅŸ ÅŸÉ™klin linki : " . $screenFile;
                    }

                    sendTGMessage($message);
                } else {
                    if (! $item->weight) {
                        $this->warn(" --- > " . $list['weight'] . "weight was updated");
                        $item->weight = $list['weight'];
                    }
                    $item->warehouse_id = $this->warehouse->id;
                    if ($item->user_id && ! $item->show_label) {
                        $item->show_label = true;
                    }
                    if ($item->status == 6) {
                        // Send Notification
                        Notification::sendPackage($item->id, '0');
                        /* Send notification */
                        $message = null;
                        $message .= "ğŸŒ€ï¸ <a href='https://admin." . env('DOMAIN_NAME') . "/packages/" . $item->id . "/edit'>" . $item->tracking_code . "</a> tracking kod ilÉ™ olan baÄŸlamanÄ±n Ã§É™kisi " . $list['weight'] . "kq olaraq yenilÉ™ndi vÉ™ sahibinÉ™ (" . ($item->user ? $item->user->full_name : 'TapÄ±lmadÄ±') . ") notification gÃ¶ndÉ™rildi.";

                        sendTGMessage($message);
                        $item->status = 0;
                    }

                    if (! $item->screen_file && ! $item->user_id) {
                        $screenFile = $this->getImage($client, $list['trackNumber']);
                        if ($screenFile) {
                            $this->info(" --- Added image for " . $list['trackNumber']);
                            $item->screen_file = $screenFile;

                            /* Send notification */
                            $message = null;
                            $message .= "ğŸ“¸ <a href='https://admin." . env('DOMAIN_NAME') . "/unknowns?search_type=&q=" . $item->tracking_code . "'>" . $item->tracking_code . "</a> tracking kod ilÉ™ olan baÄŸlamamÄ±n yiyÉ™si tapÄ±lmasÄ± Ã¼Ã§Ã¼n ÅŸÉ™kil É™lavÉ™ edildi.";
                            $message .= " Ã‡É™kilmiÅŸ ÅŸÉ™klin linki : " . $screenFile;

                            sendTGMessage($message);
                        } else {
                            $this->warn("No image for : " . $list['trackNumber']);
                        }
                    }

                    $item->save();
                }
            }
        }

        return $numbers;
    }

    public function rescanImage($id)
    {
        if(empty($id)) {
            $this->info("Empty package id ");
	    return;
	}
        $package = Package::find($id);
        if(!$package) {
            $this->info("Package not exists ".$id);
	    return;
	}
	$client = $this->login();
	$new_screen_file=$this->getImage($client, $package->tracking_code);
	if(!$new_screen_file) {
            $this->info("Cannot get Image file");
	    return;
	}
        if(!empty($package->screen_file)) {
            $filePath=str_replace('https://aseshop.az/','',$package->screen_file);
            if(file_exists(public_path($filePath))) 
                unlink(public_path($filePath));
	}
        $package->screen_file=$new_screen_file;
        //$package->save();

        $ocr = $this->ocrRequest($package->screen_file);
        if ($ocr) {
            /* Send notification */
            $message = null;
            $message .= "âœ… <a href='https://admin." . env('DOMAIN_NAME') . "/packages/" . $package->id . "/edit'>" . $package->tracking_code . "</a> tracking kod ilÉ™ olan yiyÉ™siz baÄŸlamanÄ±n sahibini <b>OCR</b> ilÉ™ tapdÄ±m. YenÉ™ dÉ™ manual yoxlanmalÄ±dÄ±r.";
            $message .= chr(10) . "Original ÅŸÉ™kil : " . $package->screen_file;
            $message .= chr(10) . "TapÄ±lmÄ±ÅŸ Customer ID : <b>" . $ocr['customer_id'] . "</b>";
            if ($ocr['user']) {
                $this->info('OCR: Found the user : ' . $ocr['customer_id']);
                $message .= chr(10) . "TapÄ±lmÄ±ÅŸ MÃ¼ÅŸtÉ™ri : <b>" . $ocr['user']->full_name . "</b>";
                $package->user_id = $ocr['user']->id;
                $package->save();
            } else {
                $this->info('OCR: User not found');
                $package->admin_comment = 'User not found';
                $package->save();
            }
            sendTGMessage($message);
            exit();
        } else {
            $package->admin_comment = 'Bot (OCR) cannot read the owner. Original image : ' . $package->screen_file;
            $package->save();
            $this->error('OCR: cannot read the owner');
	}
    }

    public function getImage($client, $trackingNumber)
    {
        try {
            $crawler = $client->request('GET', 'https://ukraine-express.com/index.php?m=clientarea&d=trackingphotos&tracking=' . $trackingNumber . '&lang=ru&div=us#labelphotos');
	    $this->info('https://ukraine-express.com/index.php?m=clientarea&d=trackingphotos&tracking=' . $trackingNumber . '&lang=ru&div=us#labelphotos');
            $path = $crawler->filter('.track-photo-thumb-label a')->eq(0)->attr('href');
            if (! $path) {
                return null;
            }

            $filename = "front_" . basename($path);

            \Image::make($path)->save(public_path('uploads/packages/' . $filename));

            return asset('uploads/packages/' . $filename);
        } catch (\Exception $exception) {
            return null;
        }
    }

    public function runOCR()
    {
        $packages = Package::where('warehouse_id', $this->warehouse->id)->whereNull('user_id')->where('id', '>', 3000)->whereNull('admin_comment')->whereNotNull('screen_file')->get();

        foreach ($packages as $package) {
            $this->info("Started : " . $package->screen_file);
            $ocr = $this->ocrRequest($package->screen_file);
            if ($ocr) {
                /* Send notification */
                $message = null;
                $message .= "âœ… <a href='https://admin." . env('DOMAIN_NAME') . "/packages/" . $package->id . "/edit'>" . $package->tracking_code . "</a> tracking kod ilÉ™ olan yiyÉ™siz baÄŸlamanÄ±n sahibini <b>OCR</b> ilÉ™ tapdÄ±m. YenÉ™ dÉ™ manual yoxlanmalÄ±dÄ±r.";
                $message .= chr(10) . "Original ÅŸÉ™kil : " . $package->screen_file;
                $message .= chr(10) . "TapÄ±lmÄ±ÅŸ Customer ID : <b>" . $ocr['customer_id'] . "</b>";
                if ($ocr['user']) {
                    $message .= chr(10) . "TapÄ±lmÄ±ÅŸ MÃ¼ÅŸtÉ™ri : <b>" . $ocr['user']->full_name . "</b>";
                    //$message .= chr(10) . "Telefon : " . $ocr['user']->phone;
                    $package->user_id = $ocr['user']->id;
                    $package->save();
                } else {
                    $package->admin_comment = 'User not found';
                    $package->save();
                }
                $this->info('Found the user : ' . $ocr['customer_id']);
                sendTGMessage($message);
                exit();
            } else {
                $package->admin_comment = 'Bot (OCR) cannot read the owner. Original image : ' . $package->screen_file;
                $package->save();
                $this->error('Cannot find');
            }
        }
    }

    public function attachScreenFiles()
    {
        $packages = Package::where('warehouse_id', $this->warehouse->id)->whereNull('user_id')->where('id', '>', 3000)->whereNull('screen_file')->get();
        $client = $this->login();
        foreach ($packages as $package) {
            $screenFile = $this->getImage($client, $package->tracking_code);
            $package->screen_file = $screenFile;
            $package->save();

            if ($screenFile) {
                /* Send notification */
                $message = null;
                $message .= "ğŸ¤– <a href='https://admin." . env('DOMAIN_NAME') . "/packages/" . $package->id . "/edit'>" . $package->tracking_code . "</a> sahibi yoxdur, tapÄ±lmasÄ± Ã¼Ã§Ã¼n screen file É™lavÉ™ edildi. Ã‡É™kilmiÅŸ ÅŸÉ™klin linki : " . $screenFile;

                //dump($message);
                sendTGMessage($message);
            }
        }
    }

    public function ocrRequest($url)
    {
        $curl = curl_init();

        curl_setopt_array($curl, [
            CURLOPT_URL => "https://api8.ocr.space/parse/image?trackingId=423d4645484542433b3c42423c4241464141443d3b46&carrier=Auto-Detect&language=en&country=Russian%2BFederation&platform=web-desktop&timestamp=1579848456645&wd=false&c=false&p=2&l=2",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 30000,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "POST",
            CURLOPT_POSTFIELDS => "-----011000010111000001101001\r\nContent-Disposition: form-data; name=\"url\"\r\n\r\n" . $url . "\r\n-----011000010111000001101001\r\nContent-Disposition: form-data; name=\"OCREngine\"\r\n\r\n2\r\n-----011000010111000001101001\r\nContent-Disposition: form-data; name=\"scale\"\r\n\r\ntrue\r\n-----011000010111000001101001\r\nContent-Disposition: form-data; name=\"isSearchablePdfHideTextLayer\"\r\n\r\ntrue\r\n-----011000010111000001101001\r\nContent-Disposition: form-data; name=\"FileType\"\r\n\r\n.jpg\r\n-----011000010111000001101001--\r\n",
            CURLOPT_HTTPHEADER => [
                "apikey: 5a64d478-9c89-43d8-88e3-c65de9999580",
                "content-type: multipart/form-data; boundary=---011000010111000001101001",
                "host: api8.ocr.space",
                "origin: http://ocr.space",
                "referer: http://ocr.space/",
                "sec-fetch-site: cross-site",
            ],
        ]);

        $response = curl_exec($curl);
        $err = curl_error($curl);

        curl_close($curl);

        if ($err) {
            $this->error('Error. Cannot read the image!');
        } else {
            $data = \GuzzleHttp\json_decode($response, true);

            if (isset($data['ParsedResults'][0]['ParsedText'])) {
                $text = $data['ParsedResults'][0]['ParsedText'];
                $cId = $this->findASECustomerId($text);

                //dd($cId);
                return $cId;
            } else {
                $this->error('Error. Cannot read the image! OCR issue');
            }
        }

        return false;
    }

    public function findASECustomerId($text)
    {
        preg_match('/ASE[0-9]{4,5}/', $text, $result_array);
        if ($result_array && isset($result_array[0]) && ! empty($result_array[0])) {
            $cId = $result_array[0];
            $user = ModelUser::where('customer_id', $cId)->first();

            return [
                'customer_id' => $cId,
                'user'        => $user ? $user : null,
            ];
        } else {
            preg_match('/ASE [0-9]{4,5}/', $text, $result_array);

            if ($result_array && isset($result_array[0]) && ! empty($result_array[0])) {
                $cId = str_replace(" ", "", $result_array[0]);
                $user = ModelUser::where('customer_id', $cId)->first();

                return [
                    'customer_id' => $cId,
                    'user'        => $user ? $user : null,
                ];
            }
        }

        return false;
    }
}
